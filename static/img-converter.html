<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡è½‰æ›å™¨</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .drop-zone-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
        .main-preview {
            max-height: 50vh;
            max-width: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen">
    <div id="app" v-cloak class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                ğŸ–¼ï¸ åœ–ç‰‡è½‰æ›å™¨
            </h1>
            <p class="text-slate-500 mt-2">æ”¯æ´ WebPã€PNGã€JPG æ ¼å¼è½‰æ›</p>
            <div class="flex justify-center gap-2 mt-4 flex-wrap">
                <span class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded-full text-sm font-medium">WebP è½‰æ›</span>
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm font-medium">PNG è½‰æ›</span>
                <span class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-sm font-medium">JPG è½‰æ›</span>
                <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium">åœ–ç‰‡å£“ç¸®</span>
                <span class="px-3 py-1 bg-pink-100 text-pink-700 rounded-full text-sm font-medium">æ‰¹æ¬¡è½‰æª”</span>
            </div>
        </header>

        <!-- ä¸Šå‚³å€åŸŸ -->
        <div 
            class="border-4 border-dashed border-slate-300 rounded-2xl p-12 text-center mb-8 transition-all duration-300 cursor-pointer hover:border-blue-400 hover:bg-blue-50"
            :class="{ 'drop-zone-active': isDragging }"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop"
            @click="$refs.fileInput.click()"
            tabindex="0"
        >
            <input 
                type="file" 
                ref="fileInput" 
                class="hidden" 
                accept="image/*" 
                multiple 
                @change="handleFileSelect"
            >
            <div class="text-6xl mb-4">ğŸ“</div>
            <p class="text-xl text-slate-600 font-medium">é»æ“Šé¸æ“‡åœ–ç‰‡ã€æ‹–æ›³åœ–ç‰‡åˆ°æ­¤è™•</p>
            <p class="text-slate-400 mt-2">æˆ–æŒ‰ Ctrl+V è²¼ä¸Šå‰ªè²¼ç°¿ä¸­çš„åœ–ç‰‡</p>
        </div>

        <!-- åœ–å»Šå€åŸŸ -->
        <div v-if="images.length > 0" class="mb-8">
            <!-- æ¨™é¡Œåˆ— -->
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-slate-700">
                    ğŸ“· åœ–ç‰‡é è¦½ ({{ images.length }} å¼µ)
                    <span v-if="currentConvertedFormat" class="text-base font-normal text-emerald-600 ml-2">
                        âœ¨ å·²è½‰æ›ç‚º {{ currentConvertedFormat.toUpperCase() }}
                    </span>
                </h2>
                <button 
                    @click="clearAll"
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                >
                    ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨
                </button>
            </div>

            <!-- ä¸­å¤®å¤§åœ–é è¦½å€ -->
            <div class="bg-slate-800 rounded-2xl p-6 mb-4 flex items-center justify-center min-h-[300px]" style="max-height: 55vh;">
                <div v-if="selectedImage" class="relative">
                    <img 
                        :src="selectedImage.convertedUrl || selectedImage.preview" 
                        class="main-preview rounded-lg shadow-2xl cursor-pointer"
                        :alt="getDownloadFilename(selectedImage)"
                        @click="downloadImage(selectedImage)"
                    >
                    <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                    <button 
                        @click="downloadImage(selectedImage)"
                        class="absolute bottom-4 right-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg flex items-center gap-2"
                    >
                        ğŸ’¾ ä¸‹è¼‰
                    </button>
                </div>
                <p v-else class="text-slate-400 text-lg">è«‹é¸æ“‡ä¸€å¼µåœ–ç‰‡</p>
            </div>

            <!-- å¤§åœ–ä¸‹æ–¹æç¤º -->
            <div v-if="selectedImage" class="text-center mb-4">
                <span class="text-slate-500 text-sm">
                    ğŸ’¾ é»æ“Šåœ–ç‰‡ä¸‹è¼‰: <strong class="text-slate-700">{{ getDownloadFilename(selectedImage) }}</strong>
                </span>
            </div>

            <!-- ä¸‹æ–¹ç¸®åœ–åˆ—è¡¨ -->
            <div class="flex gap-3 overflow-x-auto py-3 px-1">
                <div 
                    v-for="(img, index) in images" 
                    :key="img.id"
                    class="relative flex-shrink-0 group cursor-pointer"
                >
                    <img 
                        :src="img.convertedUrl || img.preview" 
                        class="w-20 h-20 object-cover rounded-lg shadow-md transition-all duration-200"
                        :class="selectedImage && selectedImage.id === img.id ? 'ring-4 ring-blue-500 scale-110' : 'hover:ring-2 hover:ring-slate-400 hover:scale-105'"
                        :alt="getDownloadFilename(img)"
                        @click="selectImage(img)"
                    >
                    <!-- ä¸‹è¼‰æŒ‰éˆ• -->
                    <button 
                        @click.stop="downloadImage(img)"
                        class="absolute bottom-1 right-1 w-6 h-6 bg-blue-600 text-white text-xs rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-blue-700 flex items-center justify-center shadow-lg"
                        title="ä¸‹è¼‰"
                    >
                        ğŸ’¾
                    </button>
                    <!-- åˆªé™¤æŒ‰éˆ• -->
                    <button 
                        @click.stop="removeImage(index)"
                        class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white text-xs rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center shadow-lg"
                    >
                        âœ•
                    </button>
                </div>
            </div>
        </div>

        <!-- è½‰æ›æ§åˆ¶é¢æ¿ -->
        <div v-if="images.length > 0" class="space-y-4">
            <!-- WebP æ§åˆ¶é … -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸŒ</span>
                        <span class="font-bold text-lg text-emerald-600">WebP</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">å£“ç¸®å“è³ª:</label>
                        <input 
                            type="number" 
                            v-model.number="webpQuality" 
                            min="1" 
                            max="100" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">ç¸®æ”¾æ¯”ä¾‹:</label>
                        <input 
                            type="number" 
                            v-model.number="webpScale" 
                            min="1" 
                            max="200" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex gap-2 ml-auto">
                        <button 
                            @click="convertAll('webp')"
                            class="px-4 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-colors"
                        >
                            è½‰æˆ WebP
                        </button>
                        <button 
                            @click="downloadAllAsZip('webp')"
                            class="px-4 py-2 bg-emerald-700 text-white rounded-lg hover:bg-emerald-800 transition-colors"
                            :disabled="isProcessing"
                        >
                            {{ isProcessing && currentFormat === 'webp' ? 'è™•ç†ä¸­...' : 'å…¨éƒ¨å­˜æˆ WebP.zip' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- PNG æ§åˆ¶é … -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ–¼ï¸</span>
                        <span class="font-bold text-lg text-blue-600">PNG</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">å£“ç¸®å“è³ª:</label>
                        <input 
                            type="number" 
                            v-model.number="pngQuality" 
                            min="1" 
                            max="100" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">ç¸®æ”¾æ¯”ä¾‹:</label>
                        <input 
                            type="number" 
                            v-model.number="pngScale" 
                            min="1" 
                            max="200" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex gap-2 ml-auto">
                        <button 
                            @click="convertAll('png')"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                        >
                            è½‰æˆ PNG
                        </button>
                        <button 
                            @click="downloadAllAsZip('png')"
                            class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800 transition-colors"
                            :disabled="isProcessing"
                        >
                            {{ isProcessing && currentFormat === 'png' ? 'è™•ç†ä¸­...' : 'å…¨éƒ¨å­˜æˆ PNG.zip' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- JPG æ§åˆ¶é … -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">ğŸ“¸</span>
                        <span class="font-bold text-lg text-orange-600">JPG</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">å£“ç¸®å“è³ª:</label>
                        <input 
                            type="number" 
                            v-model.number="jpgQuality" 
                            min="1" 
                            max="100" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-slate-600">ç¸®æ”¾æ¯”ä¾‹:</label>
                        <input 
                            type="number" 
                            v-model.number="jpgScale" 
                            min="1" 
                            max="200" 
                            class="w-20 px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                        >
                        <span class="text-slate-500">%</span>
                    </div>
                    <div class="flex gap-2 ml-auto">
                        <button 
                            @click="convertAll('jpg')"
                            class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors"
                        >
                            è½‰æˆ JPG
                        </button>
                        <button 
                            @click="downloadAllAsZip('jpg')"
                            class="px-4 py-2 bg-orange-700 text-white rounded-lg hover:bg-orange-800 transition-colors"
                            :disabled="isProcessing"
                        >
                            {{ isProcessing && currentFormat === 'jpg' ? 'è™•ç†ä¸­...' : 'å…¨éƒ¨å­˜æˆ JPG.zip' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                const images = ref([]);
                const selectedImage = ref(null);
                const isDragging = ref(false);
                const isProcessing = ref(false);
                const currentFormat = ref('');
                const currentConvertedFormat = ref('');

                // å“è³ªè¨­å®š
                const webpQuality = ref(80);
                const pngQuality = ref(100);
                const jpgQuality = ref(80);

                // ç¸®æ”¾è¨­å®š
                const webpScale = ref(100);
                const pngScale = ref(100);
                const jpgScale = ref(100);

                let imageIdCounter = 0;

                // ç”Ÿæˆæ™‚é–“æˆ³æª”åï¼ˆç”¨æ–¼å‰ªè²¼ç°¿è²¼ä¸Šç­‰æ²’æœ‰åŸå§‹æª”åçš„æƒ…æ³ï¼‰
                const generateTimestampFilename = (ext) => {
                    const now = new Date();
                    const timestamp = now.getFullYear().toString() +
                        String(now.getMonth() + 1).padStart(2, '0') +
                        String(now.getDate()).padStart(2, '0') +
                        String(now.getHours()).padStart(2, '0') +
                        String(now.getMinutes()).padStart(2, '0') +
                        String(now.getSeconds()).padStart(2, '0');
                    return `${timestamp}.${ext}`;
                };

                // æª¢æŸ¥æ˜¯å¦ç‚ºå‰ªè²¼ç°¿åœ–ç‰‡ï¼ˆæ²’æœ‰çœŸå¯¦æª”åï¼‰
                const isClipboardImage = (filename) => {
                    // å‰ªè²¼ç°¿è²¼ä¸Šçš„åœ–ç‰‡é€šå¸¸æ²’æœ‰å‰¯æª”åæˆ–æ˜¯ image.png é€™é¡é€šç”¨åç¨±
                    return !filename || filename === '' || /^image\.(png|jpg|jpeg|webp|gif|bmp)$/i.test(filename);
                };

                // å–å¾—ä¸å«å‰¯æª”åçš„æª”æ¡ˆåŸºæœ¬åç¨±
                const getBaseName = (filename) => {
                    const lastDot = filename.lastIndexOf('.');
                    return lastDot > 0 ? filename.substring(0, lastDot) : filename;
                };

                // ç”Ÿæˆå”¯ä¸€æª”åï¼ˆè™•ç†é‡è¤‡ï¼‰
                const generateUniqueFilename = (baseName, ext, usedNames) => {
                    let filename = `${baseName}.${ext}`;
                    if (!usedNames.has(filename)) {
                        usedNames.add(filename);
                        return filename;
                    }
                    // æª”åé‡è¤‡ï¼ŒåŠ ä¸Šåºè™Ÿ
                    let counter = 1;
                    while (true) {
                        filename = `${baseName}-${String(counter).padStart(3, '0')}.${ext}`;
                        if (!usedNames.has(filename)) {
                            usedNames.add(filename);
                            return filename;
                        }
                        counter++;
                    }
                };

                // å–å¾—ä¸‹è¼‰æª”å
                const getDownloadFilename = (img) => {
                    if (img.convertedFilename) {
                        return img.convertedFilename;
                    }
                    // æœªè½‰æ›æ™‚ï¼Œä½¿ç”¨åŸåœ–å‰¯æª”å
                    const ext = img.name.split('.').pop().toLowerCase() || 'png';
                    if (isClipboardImage(img.name)) {
                        return generateTimestampFilename(ext);
                    }
                    return img.name;
                };

                // å–å¾—ä¸‹è¼‰ URL
                const getDownloadUrl = (img) => {
                    return img.convertedUrl || img.preview;
                };

                // é¸æ“‡åœ–ç‰‡
                const selectImage = (img) => {
                    selectedImage.value = img;
                };

                // ä¸‹è¼‰å–®å¼µåœ–ç‰‡
                const downloadImage = (img) => {
                    const url = img.convertedUrl || img.preview;
                    const filename = getDownloadFilename(img);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                };

                // è™•ç†æª”æ¡ˆé¸æ“‡
                const handleFileSelect = (e) => {
                    const files = Array.from(e.target.files);
                    addImages(files);
                    e.target.value = '';
                };

                // è™•ç†æ‹–æ›³
                const handleDrop = (e) => {
                    isDragging.value = false;
                    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
                    addImages(files);
                };

                // å…¨åŸŸè²¼ä¸Šäº‹ä»¶
                document.addEventListener('paste', (e) => {
                    const items = Array.from(e.clipboardData?.items || []);
                    const imageFiles = items
                        .filter(item => item.type.startsWith('image/'))
                        .map(item => item.getAsFile())
                        .filter(Boolean);
                    if (imageFiles.length > 0) {
                        addImages(imageFiles);
                    }
                });

                // æ–°å¢åœ–ç‰‡
                const addImages = (files) => {
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const newImg = {
                                id: ++imageIdCounter,
                                name: file.name,
                                file: file,
                                preview: e.target.result,
                                convertedUrl: null,
                                convertedFilename: null,
                                convertedBlob: null
                            };
                            images.value.push(newImg);
                            // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å¼µåœ–ç‰‡
                            if (!selectedImage.value) {
                                selectedImage.value = newImg;
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                };

                // ç§»é™¤å–®å¼µåœ–ç‰‡
                const removeImage = (index) => {
                    const img = images.value[index];
                    if (img.convertedUrl) {
                        URL.revokeObjectURL(img.convertedUrl);
                    }
                    images.value.splice(index, 1);
                    // å¦‚æœç§»é™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„åœ–ç‰‡ï¼Œé¸æ“‡ç¬¬ä¸€å¼µ
                    if (selectedImage.value && selectedImage.value.id === img.id) {
                        selectedImage.value = images.value[0] || null;
                    }
                };

                // æ¸…é™¤å…¨éƒ¨
                const clearAll = () => {
                    // é‡‹æ”¾ Blob URL
                    images.value.forEach(img => {
                        if (img.convertedUrl) {
                            URL.revokeObjectURL(img.convertedUrl);
                        }
                    });
                    images.value = [];
                    selectedImage.value = null;
                    currentConvertedFormat.value = '';
                };

                // è½‰æ›åœ–ç‰‡
                const convertImage = (imgData, format, quality, scale, usedNames) => {
                    return new Promise((resolve) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            
                            const newWidth = Math.round(img.width * (scale / 100));
                            const newHeight = Math.round(img.height * (scale / 100));
                            
                            canvas.width = newWidth;
                            canvas.height = newHeight;
                            
                            // JPG éœ€è¦ç™½è‰²èƒŒæ™¯
                            if (format === 'jpg' || format === 'jpeg') {
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, newWidth, newHeight);
                            }
                            
                            ctx.drawImage(img, 0, 0, newWidth, newHeight);
                            
                            let mimeType = 'image/webp';
                            let ext = 'webp';
                            if (format === 'png') {
                                mimeType = 'image/png';
                                ext = 'png';
                            } else if (format === 'jpg' || format === 'jpeg') {
                                mimeType = 'image/jpeg';
                                ext = 'jpg';
                            }
                            
                            // æ±ºå®šæª”åï¼šå‰ªè²¼ç°¿åœ–ç‰‡ç”¨æ™‚é–“æˆ³ï¼Œå…¶ä»–ä¿ç•™åŸå
                            let filename;
                            if (isClipboardImage(imgData.name)) {
                                filename = generateUniqueFilename(
                                    generateTimestampFilename(ext).replace(`.${ext}`, ''),
                                    ext,
                                    usedNames
                                );
                            } else {
                                const baseName = getBaseName(imgData.name);
                                filename = generateUniqueFilename(baseName, ext, usedNames);
                            }
                            
                            // ä½¿ç”¨ toBlob ä¸¦å»ºç«‹ Blob URL
                            canvas.toBlob((blob) => {
                                const blobUrl = URL.createObjectURL(blob);
                                resolve({
                                    dataUrl: blobUrl,
                                    filename: filename,
                                    blob: blob
                                });
                            }, mimeType, quality / 100);
                        };
                        img.src = imgData.preview;
                    });
                };

                // DataURL è½‰ Blob
                const dataURLtoBlob = (dataURL) => {
                    const arr = dataURL.split(',');
                    const mime = arr[0].match(/:(.*?);/)[1];
                    const bstr = atob(arr[1]);
                    let n = bstr.length;
                    const u8arr = new Uint8Array(n);
                    while (n--) {
                        u8arr[n] = bstr.charCodeAt(n);
                    }
                    return new Blob([u8arr], { type: mime });
                };

                // è½‰æ›å…¨éƒ¨åœ–ç‰‡ï¼ˆç›´æ¥æ›´æ–°åŸåœ–ï¼‰
                const convertAll = async (format) => {
                    let quality, scale;
                    if (format === 'webp') {
                        quality = webpQuality.value;
                        scale = webpScale.value;
                    } else if (format === 'png') {
                        quality = pngQuality.value;
                        scale = pngScale.value;
                    } else {
                        quality = jpgQuality.value;
                        scale = jpgScale.value;
                    }

                    const usedNames = new Set();
                    for (let i = 0; i < images.value.length; i++) {
                        const img = images.value[i];
                        // é‡‹æ”¾èˆŠçš„ Blob URL
                        if (img.convertedUrl) {
                            URL.revokeObjectURL(img.convertedUrl);
                        }
                        const result = await convertImage(img, format, quality, scale, usedNames);
                        // ç›´æ¥æ›´æ–°åŸåœ–è³‡æ–™
                        images.value[i].convertedUrl = result.dataUrl;
                        images.value[i].convertedFilename = result.filename;
                        images.value[i].convertedBlob = result.blob;
                    }
                    currentConvertedFormat.value = format;
                };

                // ä¸‹è¼‰å…¨éƒ¨ç‚º ZIP
                const downloadAllAsZip = async (format) => {
                    if (isProcessing.value) return;
                    
                    isProcessing.value = true;
                    currentFormat.value = format;

                    let quality, scale;
                    if (format === 'webp') {
                        quality = webpQuality.value;
                        scale = webpScale.value;
                    } else if (format === 'png') {
                        quality = pngQuality.value;
                        scale = pngScale.value;
                    } else {
                        quality = jpgQuality.value;
                        scale = jpgScale.value;
                    }

                    try {
                        const zip = new JSZip();
                        const usedNames = new Set();
                        
                        for (let i = 0; i < images.value.length; i++) {
                            const img = images.value[i];
                            const result = await convertImage(img, format, quality, scale, usedNames);
                            zip.file(result.filename, result.blob);
                            
                            // åŒæ™‚æ›´æ–°åœ–ç‰‡é è¦½
                            if (img.convertedUrl) {
                                URL.revokeObjectURL(img.convertedUrl);
                            }
                            img.convertedUrl = result.dataUrl;
                            img.convertedFilename = result.filename;
                            img.convertedBlob = result.blob;
                        }
                        currentConvertedFormat.value = format;

                        const content = await zip.generateAsync({ type: 'blob' });
                        
                        // ç”Ÿæˆæª”å imgs-yyyyMMdd-HHmmss.zip
                        const now = new Date();
                        const timestamp = now.getFullYear().toString() +
                            String(now.getMonth() + 1).padStart(2, '0') +
                            String(now.getDate()).padStart(2, '0') + '-' +
                            String(now.getHours()).padStart(2, '0') +
                            String(now.getMinutes()).padStart(2, '0') +
                            String(now.getSeconds()).padStart(2, '0');
                        
                        const filename = `imgs-${timestamp}.zip`;
                        
                        // ä¸‹è¼‰
                        const url = URL.createObjectURL(content);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('ZIP æ‰“åŒ…å¤±æ•—:', error);
                        alert('ZIP æ‰“åŒ…å¤±æ•—ï¼Œè«‹é‡è©¦');
                    } finally {
                        isProcessing.value = false;
                        currentFormat.value = '';
                    }
                };

                return {
                    images,
                    selectedImage,
                    isDragging,
                    isProcessing,
                    currentFormat,
                    currentConvertedFormat,
                    webpQuality,
                    pngQuality,
                    jpgQuality,
                    webpScale,
                    pngScale,
                    jpgScale,
                    handleFileSelect,
                    handleDrop,
                    selectImage,
                    downloadImage,
                    removeImage,
                    clearAll,
                    convertAll,
                    downloadAllAsZip,
                    getDownloadFilename,
                    getDownloadUrl
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
